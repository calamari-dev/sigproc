\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{sigproc-base}[2022/04/29 sigproc-base]

\RequirePackage{xcolor}
\RequirePackage{amsthm,thmtools}
\RequirePackage{wrapfig}
\RequirePackage{tcolorbox}
\RequirePackage{cleveref}
\tcbuselibrary{minted,breakable,skins,theorems}

% 参照
\crefname{chapter}{}{}
\crefname{equation}{式}{式}
\crefname{figure}{図}{図}
\crefname{problem}{演習問題}{演習問題}
\crefname{section}{}{}
\crefname{subsection}{}{}
\crefname{table}{表}{表}

\creflabelformat{chapter}{第#2#1#3章}
\creflabelformat{section}{第#2#1#3節}
\creflabelformat{subsection}{第#2#1#3小節}

\newcommand{\crefrangeconjunction}{から}
\newcommand{\crefpairconjunction}{，}
\newcommand{\crefmiddleconjunction}{，}
\newcommand{\creflastconjunction}{，および}

% 約物・論理構造
\newcommand{\alert}[1]{{\gtfamily\bfseries #1}}
\newcommand{\impact}[1]{{\gtfamily\bfseries #1}}
\newcommand{\termdef}[1]{{\gtfamily\bfseries #1}}
\newcommand{\texttwoemdash}{\resizebox{2\zw}{\height}{—}}

% リード文
\newenvironment{lead}{%
  \begin{list}{}{%
    \setlength{\listparindent}{\parindent}%
    \setlength{\itemindent}{\parindent}%
    \setlength{\leftmargin}{4\zw}%
    \setlength{\rightmargin}{0pt}%
  }%
  \item\small
}{\end{list}}

% 定理環境
\newcounter{thcounter}
\numberwithin{thcounter}{section}

\declaretheoremstyle[
  headfont=\sffamily\bfseries,
  headpunct={},
  notebraces={\inhibitglue（}{）\hspace{-0.5\zw}},
  notefont=\sffamily\bfseries,
  postheadspace=1\zw,
  qed=\diamondsuit
]{egstyle}

\declaretheoremstyle[
  bodyfont=\small,
  headfont=\sffamily\bfseries\small,
  headpunct={},
  notebraces={\inhibitglue（}{）\hspace{-0.5\zw}},
  notefont=\sffamily\bfseries\small,
  numbered=no,
  postheadspace=1\zw
]{notestyle}

\crefname{example}{例}{例}

\declaretheorem[sibling=thcounter,style=egstyle,name=例]{example}
\declaretheorem[style=egstyle,name=問]{problem}
\declaretheorem[style=notestyle,name=ノート]{note}

\tcolorboxenvironment{note}{
  blanker,
  borderline west={0.45\zw}{0pt}{lightgray},
  breakable,
  left=0.9\zw
}

\tcbset{
  mytheorem/.style={
    enhanced jigsaw,
    breakable,
    beforeafter skip balanced={0.5\baselineskip},
    theorem style=plain,
    label type={#1},
    fonttitle=\sffamily\bfseries,
    description delimiters={\inhibitglue（}{）\hspace{-0.5\zw}},
    terminator sign={\hspace{\zw}},
    coltitle=black,
    colframe=black,
    opacityback=0.0,
    opacitybacktitle=0.0,
    top=0.5\zh,
    right=0.5\zw,
    bottom=0.5\zh,
    left=0.5\zw,
    arc=0pt,
    boxrule=0.4pt
  }
}

\newcommand{\base@declareframedtheorem}[2]{%
  \crefname{#1}{#2}{#2}%
  \newtcbtheorem[use counter=thcounter,number freestyle={\noexpand\thesection.\noexpand\arabic{\tcbcounter}}]{#1}{#2}{mytheorem=#1}{#1}%
}

\base@declareframedtheorem{corollary}{系}
\base@declareframedtheorem{definition}{定義}
\base@declareframedtheorem{exercise}{例題}
\base@declareframedtheorem{lemma}{補題}
\base@declareframedtheorem{proposition}{命題}
\base@declareframedtheorem{theorem}{定理}

% コードブロック
\def\base@codeblockoptions{
  listing only,
  listing engine=minted,
  minted style=bw,
  minted options={fontsize=\small,baselinestretch=0.9},
  enhanced jigsaw,
  breakable,
  beforeafter skip balanced={0.5\baselineskip},
  colframe=black,
  colback=white!97!black,
  top=0.5\zh,
  bottom=0.5\zh,
  left=0.5\zw,
  right=0.5\zw,
  arc=0pt,
  boxrule=0.4pt
}

\newtcblisting{codeblock}[1]{
  minted language=#1,
  code={\pgfkeysalsofrom{\base@codeblockoptions}}
}

\newtcbinputlisting{\inputcodeblock}[2]{
  listing file={#2},
  minted language=#1,
  code={\pgfkeysalsofrom{\base@codeblockoptions}}
}
